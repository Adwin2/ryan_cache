# 高性能分布式缓存系统架构文档

## 🎯 项目概述

本项目是一个基于Go语言开发的高性能分布式缓存系统，采用一致性哈希算法实现数据分布，支持自动数据迁移、故障检测和负载均衡。

## 🏗️ 系统架构

### 分层架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                    Client Layer                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Web App   │  │   Mobile    │  │   Service   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
                         REST API
                              │
┌─────────────────────────────────────────────────────────────┐
│                 Distributed Layer                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Node 1    │  │   Node 2    │  │   Node 3    │         │
│  │   :8001     │  │   :8002     │  │   :8003     │         │
│  │             │  │             │  │             │         │
│  │ ┌─────────┐ │  │ ┌─────────┐ │  │ ┌─────────┐ │         │
│  │ │Gin API  │ │  │ │Gin API  │ │  │ │Gin API  │ │         │
│  │ └─────────┘ │  │ └─────────┘ │  │ └─────────┘ │         │
│  │ ┌─────────┐ │  │ ┌─────────┐ │  │ ┌─────────┐ │         │
│  │ │Cluster  │ │  │ │Cluster  │ │  │ │Cluster  │ │         │
│  │ │Manager  │ │  │ │Manager  │ │  │ │Manager  │ │         │
│  │ └─────────┘ │  │ └─────────┘ │  │ └─────────┘ │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
                    HTTP Inter-Node Communication
                              │
┌─────────────────────────────────────────────────────────────┐
│                   Core Cache Layer                          │
│                                                             │
│              DistributedCache                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  • 一致性哈希算法                                      │   │
│  │  • 虚拟节点管理                                        │   │
│  │  • 数据迁移逻辑                                        │   │
│  │  • 并发安全控制                                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                              │                             │
│                         LRUCache                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  • LRU淘汰策略                                         │   │
│  │  • 高性能读写                                          │   │
│  │  • 内存管理                                            │   │
│  │  • 统计信息                                            │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 🧩 核心组件

### 1. LRUCache (lru_cache.go)
- **职责**: 高性能本地缓存实现
- **特性**:
  - LRU淘汰策略
  - 双向链表 + 哈希表实现
  - 并发安全
  - 统计信息收集

### 2. DistributedCache (distributed_cache.go)
- **职责**: 分布式缓存核心逻辑
- **特性**:
  - 一致性哈希算法
  - 虚拟节点管理 (150个/节点)
  - 自动数据迁移
  - 增量哈希环操作

### 3. NodeServer (distributed/node_server.go)
- **职责**: HTTP服务器包装器
- **特性**:
  - Gin框架REST API
  - 优雅关闭
  - CORS支持
  - 中间件支持

### 4. ClusterManager (distributed/cluster_manager.go)
- **职责**: 集群状态管理
- **特性**:
  - 节点发现和注册
  - 健康检查 (10秒间隔)
  - 故障检测
  - 集群拓扑维护

### 5. APIHandlers (distributed/api_handlers.go)
- **职责**: HTTP请求处理
- **特性**:
  - 请求验证和解析
  - 响应格式化
  - 错误处理
  - 内部API支持

### 6. DistributedClient (distributed/client.go)
- **职责**: 客户端SDK
- **特性**:
  - 负载均衡
  - 故障转移
  - 批量操作
  - 重试机制

## 🔄 数据流程

### 写操作流程
1. 客户端发送PUT请求到任意节点
2. 节点计算key的哈希值
3. 根据一致性哈希确定目标节点
4. 如果是本地节点，直接写入；否则转发请求
5. 目标节点写入LRU缓存
6. 返回响应

### 读操作流程
1. 客户端发送GET请求到任意节点
2. 节点计算key的哈希值
3. 根据一致性哈希确定目标节点
4. 如果是本地节点，直接读取；否则转发请求
5. 目标节点从LRU缓存读取
6. 返回数据

### 节点加入流程
1. 新节点启动并加载配置
2. 向集群中其他节点发送加入通知
3. 其他节点更新集群拓扑
4. 重新构建哈希环
5. 执行数据迁移
6. 更新统计信息

### 节点离开流程
1. 节点发送离开通知
2. 其他节点更新集群拓扑
3. 重新构建哈希环
4. 将离开节点的数据迁移到其他节点
5. 清理相关资源

## 🎯 核心算法

### 一致性哈希算法
```go
// 1. 计算key的哈希值
hash := hashKey(key)

// 2. 在哈希环中查找
idx := sort.Search(len(sortedHashes), func(i int) bool {
    return sortedHashes[i] >= hash
})

// 3. 环形处理
if idx == len(sortedHashes) {
    idx = 0
}

// 4. 返回对应节点
return hashRing[sortedHashes[idx]]
```

### 数据迁移算法
```go
// 扩容时：只迁移新节点应该负责的数据
for key, value := range oldData {
    newNode := getNodeForKey(key)
    if newNode == addedNode {
        migrateData(key, value, newNode)
    }
}

// 缩容时：将被删除节点的数据重新分布
for key, value := range removedNodeData {
    newNode := getNodeForKey(key)
    migrateData(key, value, newNode)
}
```

## 📊 性能特性

### 时间复杂度
- **查找节点**: O(log N) - 二分查找
- **数据读写**: O(1) - 哈希表操作
- **LRU操作**: O(1) - 双向链表

### 空间复杂度
- **哈希环**: O(V×N) - V为虚拟节点数，N为物理节点数
- **LRU缓存**: O(C) - C为缓存容量

### 并发性能
- **读写分离锁**: 支持多读单写
- **无锁LRU**: 关键路径优化
- **批量操作**: 减少网络开销

## 🔧 配置说明

### 节点配置 (config/nodeX.yaml)
```yaml
node_id: "node1"           # 节点唯一标识
address: ":8001"           # 监听地址
cluster_nodes:             # 集群节点列表
  node1: "localhost:8001"
  node2: "localhost:8002"
  node3: "localhost:8003"
cache_size: 1000          # 本地缓存大小
virtual_nodes: 150        # 虚拟节点数量
```

### 客户端配置
```go
config := ClientConfig{
    Nodes:      []string{"localhost:8001", "localhost:8002", "localhost:8003"},
    Timeout:    5 * time.Second,
    RetryCount: 3,
}
```

## 🚀 部署架构

### 单机部署
- 3个节点进程
- 端口: 8001, 8002, 8003
- 共享配置文件

### 分布式部署
- 每个节点独立服务器
- 网络通信
- 配置中心管理

### 容器化部署
- Docker镜像
- Kubernetes编排
- 服务发现

## 🔍 监控指标

### 缓存指标
- 命中率 (Hit Rate)
- 未命中率 (Miss Rate)
- 缓存大小 (Cache Size)
- 淘汰次数 (Evictions)

### 集群指标
- 节点健康状态
- 数据分布均匀度
- 迁移统计
- 网络延迟

### 性能指标
- QPS (Queries Per Second)
- 响应时间 (Response Time)
- 吞吐量 (Throughput)
- 错误率 (Error Rate)

## 🛡️ 容错机制

### 故障检测
- 定期健康检查 (10秒)
- 超时检测 (3秒)
- 心跳机制

### 故障恢复
- 自动重试 (3次)
- 节点切换
- 数据重新分布

### 数据一致性
- 最终一致性
- 冲突解决
- 版本控制

## 📈 扩展性

### 水平扩展
- 动态添加节点
- 自动数据迁移
- 负载重新分布

### 垂直扩展
- 增加缓存容量
- 提升单节点性能
- 优化算法实现

### 功能扩展
- 数据持久化
- 主从复制
- 分片策略
