# ç¬¬äº”ç« ï¼šå¤šçº§ç¼“å­˜

> ğŸ¯ **å­¦ä¹ ç›®æ ‡**: æŒæ¡ç°ä»£é«˜æ€§èƒ½ç³»ç»Ÿçš„å¤šçº§ç¼“å­˜æ¶æ„è®¾è®¡
> 
> âš ï¸ **é¢è¯•é‡ç‚¹**: è¿™æ˜¯å¤§å‚é¢è¯•ä¸­çš„é«˜é¢‘æ¶æ„è®¾è®¡é¢˜ï¼

## ğŸ“– ç†è®ºçŸ¥è¯†

### ä¸ºä»€ä¹ˆéœ€è¦å¤šçº§ç¼“å­˜ï¼Ÿ

å•ä¸€ç¼“å­˜å±‚é¢ä¸´çš„æŒ‘æˆ˜ï¼š

1. **æ€§èƒ½ç“¶é¢ˆ**: ç½‘ç»œå»¶è¿Ÿå½±å“å“åº”æ—¶é—´
2. **å®¹é‡é™åˆ¶**: å•å±‚ç¼“å­˜å®¹é‡æœ‰é™
3. **å¯ç”¨æ€§é£é™©**: å•ç‚¹æ•…éšœå½±å“æ•´ä¸ªç³»ç»Ÿ
4. **æˆæœ¬é—®é¢˜**: é«˜æ€§èƒ½ç¼“å­˜æˆæœ¬æ˜‚è´µ

### å¤šçº§ç¼“å­˜æ¶æ„

```
åº”ç”¨ç¨‹åº
    â†“
L1: æœ¬åœ°ç¼“å­˜ (JVMå†…å­˜/è¿›ç¨‹å†…)
    â†“ (æœªå‘½ä¸­)
L2: åˆ†å¸ƒå¼ç¼“å­˜ (Redis/Memcached)
    â†“ (æœªå‘½ä¸­)  
L3: æ•°æ®åº“ (MySQL/PostgreSQL)
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. ç¼“å­˜å±‚çº§ç‰¹ç‚¹

| å±‚çº§ | ç±»å‹ | å®¹é‡ | å»¶è¿Ÿ | ä¸€è‡´æ€§ | æˆæœ¬ |
|------|------|------|------|--------|------|
| **L1** | æœ¬åœ°ç¼“å­˜ | å° | æä½(ns) | å¼± | ä½ |
| **L2** | åˆ†å¸ƒå¼ç¼“å­˜ | ä¸­ | ä½(ms) | å¼º | ä¸­ |
| **L3** | æ•°æ®åº“ | å¤§ | é«˜(ms) | å¼º | é«˜ |

### 2. ç¼“å­˜ç­–ç•¥

#### è¯»å–ç­–ç•¥ (Read-Through)
```go
func Get(key string) (value string, err error) {
    // L1: æœ¬åœ°ç¼“å­˜
    if value, exists := l1Cache.Get(key); exists {
        return value, nil
    }
    
    // L2: åˆ†å¸ƒå¼ç¼“å­˜
    if value, exists := l2Cache.Get(key); exists {
        l1Cache.Set(key, value) // å›å†™L1
        return value, nil
    }
    
    // L3: æ•°æ®åº“
    value, err = database.Query(key)
    if err == nil {
        l2Cache.Set(key, value) // å†™å…¥L2
        l1Cache.Set(key, value) // å†™å…¥L1
    }
    return value, err
}
```

#### å†™å…¥ç­–ç•¥ (Write-Through)
```go
func Set(key, value string) error {
    // å†™å…¥æ•°æ®åº“
    if err := database.Update(key, value); err != nil {
        return err
    }
    
    // æ›´æ–°L2ç¼“å­˜
    l2Cache.Set(key, value)
    
    // æ›´æ–°L1ç¼“å­˜
    l1Cache.Set(key, value)
    
    return nil
}
```

### 3. ä¸€è‡´æ€§ä¿è¯

#### é—®é¢˜ï¼šå¤šçº§ç¼“å­˜æ•°æ®ä¸ä¸€è‡´

```
æ—¶åˆ»T1: L1=v1, L2=v1, DB=v1  âœ… ä¸€è‡´
æ—¶åˆ»T2: æ›´æ–°DB=v2
æ—¶åˆ»T3: L1=v1, L2=v1, DB=v2  âŒ ä¸ä¸€è‡´
```

#### è§£å†³æ–¹æ¡ˆ

1. **TTLç­–ç•¥**: ä¸åŒå±‚çº§è®¾ç½®ä¸åŒè¿‡æœŸæ—¶é—´
2. **ä¸»åŠ¨å¤±æ•ˆ**: å†™å…¥æ—¶ä¸»åŠ¨åˆ é™¤ç¼“å­˜
3. **æ¶ˆæ¯é€šçŸ¥**: ä½¿ç”¨MQé€šçŸ¥ç¼“å­˜æ›´æ–°
4. **ç‰ˆæœ¬æ§åˆ¶**: ä½¿ç”¨ç‰ˆæœ¬å·æ£€æµ‹æ•°æ®æ–°æ—§

## ğŸ’» ä»£ç å®ç°

æŸ¥çœ‹å…·ä½“å®ç°ï¼š
- `local_cache.go` - æœ¬åœ°ç¼“å­˜å®ç°
- `distributed_cache.go` - åˆ†å¸ƒå¼ç¼“å­˜æ¨¡æ‹Ÿ
- `multilevel_cache.go` - å¤šçº§ç¼“å­˜æ ¸å¿ƒå®ç°
- `consistency.go` - ä¸€è‡´æ€§ä¿è¯æœºåˆ¶
- `demo.go` - å®Œæ•´æ¼”ç¤ºç¨‹åº

## ğŸ® åŠ¨æ‰‹å®è·µ

```bash
cd 05-multilevel
go run *.go
```

## ğŸ“ é¢è¯•è¦ç‚¹

### å¿…è€ƒé—®é¢˜

**Q: ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜ï¼Ÿä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¤šçº§ç¼“å­˜ï¼Ÿ**

A: å¤šçº§ç¼“å­˜æ˜¯å°†ç¼“å­˜åˆ†ä¸ºå¤šä¸ªå±‚çº§çš„æ¶æ„æ¨¡å¼ï¼š
- **L1æœ¬åœ°ç¼“å­˜**: æä½å»¶è¿Ÿï¼Œå®¹é‡å°
- **L2åˆ†å¸ƒå¼ç¼“å­˜**: ä½å»¶è¿Ÿï¼Œå®¹é‡ä¸­ç­‰
- **L3æ•°æ®åº“**: é«˜å»¶è¿Ÿï¼Œå®¹é‡å¤§
- **ä¼˜åŠ¿**: æé«˜æ€§èƒ½ã€é™ä½å»¶è¿Ÿã€å¢å¼ºå¯ç”¨æ€§

**Q: å¤šçº§ç¼“å­˜çš„ä¸€è‡´æ€§é—®é¢˜å¦‚ä½•è§£å†³ï¼Ÿ**

A: 
1. **TTLç­–ç•¥**: L1è®¾ç½®è¾ƒçŸ­TTLï¼ŒL2è®¾ç½®è¾ƒé•¿TTL
2. **å†™å…¥æ—¶å¤±æ•ˆ**: æ›´æ–°æ•°æ®æ—¶åˆ é™¤å„çº§ç¼“å­˜
3. **æ¶ˆæ¯é€šçŸ¥**: ä½¿ç”¨Redis Pub/Subæˆ–MQé€šçŸ¥
4. **æœ€ç»ˆä¸€è‡´æ€§**: å®¹å¿çŸ­æœŸä¸ä¸€è‡´ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´

**Q: å¦‚ä½•è®¾è®¡ä¸€ä¸ªé«˜æ€§èƒ½çš„å¤šçº§ç¼“å­˜ç³»ç»Ÿï¼Ÿ**

A:
1. **ç¼“å­˜é€‰å‹**: æœ¬åœ°ç”¨Caffeine/Guavaï¼Œåˆ†å¸ƒå¼ç”¨Redis
2. **å®¹é‡è§„åˆ’**: æ ¹æ®çƒ­ç‚¹æ•°æ®å’Œå†…å­˜é™åˆ¶è®¾è®¡å®¹é‡
3. **TTLè®¾è®¡**: L1(1-5åˆ†é’Ÿ)ï¼ŒL2(10-30åˆ†é’Ÿ)
4. **ç›‘æ§å‘Šè­¦**: å‘½ä¸­ç‡ã€å»¶è¿Ÿã€é”™è¯¯ç‡ç›‘æ§
5. **é™çº§ç­–ç•¥**: ç¼“å­˜æ•…éšœæ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ

### è¿›é˜¶é—®é¢˜

**Q: å¤šçº§ç¼“å­˜çš„æ€§èƒ½å¦‚ä½•ä¼˜åŒ–ï¼Ÿ**

A:
1. **å¼‚æ­¥æ›´æ–°**: ä½¿ç”¨å¼‚æ­¥æ–¹å¼æ›´æ–°ç¼“å­˜
2. **æ‰¹é‡æ“ä½œ**: æ‰¹é‡è·å–å’Œæ›´æ–°æ•°æ®
3. **é¢„çƒ­ç­–ç•¥**: ç³»ç»Ÿå¯åŠ¨æ—¶é¢„åŠ è½½çƒ­ç‚¹æ•°æ®
4. **æ™ºèƒ½è·¯ç”±**: æ ¹æ®æ•°æ®ç‰¹å¾é€‰æ‹©ç¼“å­˜å±‚çº§

**Q: å¦‚ä½•å¤„ç†ç¼“å­˜é›ªå´©ã€ç©¿é€ã€å‡»ç©¿ï¼Ÿ**

A: åœ¨å¤šçº§ç¼“å­˜ä¸­çš„å¤„ç†ç­–ç•¥ï¼š
1. **é›ªå´©**: ä¸åŒå±‚çº§è®¾ç½®éšæœºTTL
2. **ç©¿é€**: L1å±‚ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨
3. **å‡»ç©¿**: L2å±‚ä½¿ç”¨åˆ†å¸ƒå¼é”

## ğŸ­ ç”Ÿäº§ç¯å¢ƒå®è·µ

### çœŸå®æ¡ˆä¾‹

**æ¡ˆä¾‹1: ç”µå•†å•†å“è¯¦æƒ…é¡µ**
```
L1: æœ¬åœ°ç¼“å­˜å•†å“åŸºç¡€ä¿¡æ¯ (1åˆ†é’ŸTTL)
L2: Redisç¼“å­˜å®Œæ•´å•†å“ä¿¡æ¯ (10åˆ†é’ŸTTL)  
L3: MySQLå­˜å‚¨å•†å“æ•°æ®
```

**æ¡ˆä¾‹2: ç”¨æˆ·ä¼šè¯ç®¡ç†**
```
L1: æœ¬åœ°ç¼“å­˜æ´»è·ƒç”¨æˆ·ä¼šè¯ (5åˆ†é’ŸTTL)
L2: Redisç¼“å­˜æ‰€æœ‰ç”¨æˆ·ä¼šè¯ (30åˆ†é’ŸTTL)
L3: æ•°æ®åº“å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
```

### æ¶æ„æ¼”è¿›

#### åˆçº§æ¶æ„
```
åº”ç”¨ â†’ Redis â†’ MySQL
```

#### ä¸­çº§æ¶æ„  
```
åº”ç”¨ â†’ æœ¬åœ°ç¼“å­˜ â†’ Redis â†’ MySQL
```

#### é«˜çº§æ¶æ„
```
åº”ç”¨ â†’ L1(æœ¬åœ°) â†’ L2(Redis) â†’ L3(MySQL)
     â†“
   æ¶ˆæ¯é˜Ÿåˆ— (ä¸€è‡´æ€§ä¿è¯)
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### å»¶è¿Ÿå¯¹æ¯”

| æ“ä½œ | æœ¬åœ°ç¼“å­˜ | Redis | MySQL |
|------|----------|-------|-------|
| è¯»å– | 0.1ms | 1-5ms | 10-100ms |
| å†™å…¥ | 0.1ms | 1-5ms | 10-100ms |

### ååé‡å¯¹æ¯”

| ç¼“å­˜ç±»å‹ | QPS | å†…å­˜ä½¿ç”¨ | ç½‘ç»œå¼€é”€ |
|----------|-----|----------|----------|
| æœ¬åœ°ç¼“å­˜ | 100ä¸‡+ | é«˜ | æ—  |
| Redis | 10ä¸‡+ | ä½ | æœ‰ |
| MySQL | 1ä¸‡+ | ä½ | æœ‰ |

## ğŸ”§ æœ€ä½³å®è·µ

### 1. ç¼“å­˜è®¾è®¡åŸåˆ™

```go
// å¥½çš„è®¾è®¡
type CacheConfig struct {
    L1TTL    time.Duration // çŸ­TTL
    L2TTL    time.Duration // é•¿TTL  
    L1Size   int          // å°å®¹é‡
    L2Size   int          // å¤§å®¹é‡
}

// åçš„è®¾è®¡ - æ‰€æœ‰å±‚çº§ç›¸åŒé…ç½®
type BadCacheConfig struct {
    TTL  time.Duration // ç›¸åŒTTL
    Size int          // ç›¸åŒå®¹é‡
}
```

### 2. ç›‘æ§æŒ‡æ ‡

```go
type CacheMetrics struct {
    L1HitRate    float64 // L1å‘½ä¸­ç‡
    L2HitRate    float64 // L2å‘½ä¸­ç‡
    OverallHitRate float64 // æ€»å‘½ä¸­ç‡
    AvgLatency   time.Duration // å¹³å‡å»¶è¿Ÿ
    ErrorRate    float64 // é”™è¯¯ç‡
}
```

### 3. å®¹é‡è§„åˆ’

```go
// æ ¹æ®ä¸šåŠ¡ç‰¹å¾è§„åˆ’å®¹é‡
func PlanCacheCapacity(hotDataSize, totalDataSize int64) CacheConfig {
    return CacheConfig{
        L1Size: int(hotDataSize * 0.1),    // 10%çƒ­ç‚¹æ•°æ®
        L2Size: int(hotDataSize * 0.8),    // 80%çƒ­ç‚¹æ•°æ®
        L1TTL:  5 * time.Minute,
        L2TTL:  30 * time.Minute,
    }
}
```

## ğŸš€ é«˜çº§ç‰¹æ€§

### 1. æ™ºèƒ½é¢„çƒ­

```go
// æ ¹æ®è®¿é—®æ¨¡å¼é¢„çƒ­ç¼“å­˜
func SmartWarmup(accessLog []AccessRecord) {
    hotKeys := analyzeHotKeys(accessLog)
    for _, key := range hotKeys {
        preloadToCache(key)
    }
}
```

### 2. åŠ¨æ€TTL

```go
// æ ¹æ®è®¿é—®é¢‘ç‡åŠ¨æ€è°ƒæ•´TTL
func DynamicTTL(key string, accessCount int) time.Duration {
    baseTTL := 5 * time.Minute
    if accessCount > 1000 {
        return baseTTL * 4 // çƒ­ç‚¹æ•°æ®å»¶é•¿TTL
    }
    return baseTTL
}
```

### 3. ç¼“å­˜é™çº§

```go
// ç¼“å­˜æ•…éšœæ—¶çš„é™çº§ç­–ç•¥
func GetWithFallback(key string) (string, error) {
    // å°è¯•L1
    if value, exists := l1.Get(key); exists {
        return value, nil
    }
    
    // å°è¯•L2
    if value, exists := l2.Get(key); exists {
        return value, nil
    }
    
    // é™çº§åˆ°æ•°æ®åº“
    return database.Get(key)
}
```

## ğŸ”— ä¸‹ä¸€ç« é¢„å‘Š

ä¸‹ä¸€ç« æˆ‘ä»¬å°†å­¦ä¹ **é¢è¯•é¢˜é›†**ï¼š
- 50+å¸¸è§ç¼“å­˜é¢è¯•é¢˜
- æ ‡å‡†ç­”æ¡ˆå’Œè§£é¢˜æ€è·¯
- çœŸå®é¢è¯•åœºæ™¯æ¨¡æ‹Ÿ
- æ¶æ„è®¾è®¡é¢˜è¯¦è§£

è¿™å°†æ˜¯æ‚¨é¢è¯•å‡†å¤‡çš„æœ€åå†²åˆºï¼

---

**ç»§ç»­å­¦ä¹ **: [ç¬¬å…­ç« ï¼šé¢è¯•é¢˜é›†](../06-interview/)
